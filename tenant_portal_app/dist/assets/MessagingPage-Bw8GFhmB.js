import{r as a,j as e}from"./react-vendor-Cz9WDxg-.js";import{u as H}from"./index-BHiZdJVs.js";import{a as N}from"./apiClient-DATCuIGb.js";import"./vendor-BVwjo9X5.js";import"./nextui-vendor-BpFfdwSS.js";import"./framer-motion-hFs7l1RU.js";import"./utils-vendor-9uJw-9S8.js";import"./lucide-icons-D0L7Z31B.js";const Q=[{label:"Tenants",value:"TENANT"},{label:"Property managers",value:"PROPERTY_MANAGER"}],V=[{key:"managerName",value:""},{key:"supportEmail",value:""}],W=({token:c,templates:m,onBatchCreated:x})=>{const[u,v]=a.useState(""),[C,g]=a.useState(""),[i,A]=a.useState(""),[M,w]=a.useState(["TENANT"]),[b,P]=a.useState(""),[f,r]=a.useState(""),[p,F]=a.useState(50),[I,U]=a.useState(""),[O,$]=a.useState(V),[E,d]=a.useState(null),[S,h]=a.useState(null),[D,j]=a.useState(null),[T,R]=a.useState(null),_=a.useMemo(()=>m.find(s=>s.id===Number(i)),[i,m]),B=s=>s.split(",").map(l=>l.trim()).filter(l=>l.length>0).map(l=>Number(l)).filter(l=>Number.isFinite(l)),q=s=>{if(A(s),s){const l=m.find(o=>o.id===Number(s));l&&(g(l.body??""),!u&&l.subject&&v(l.subject))}},t=(s,l,o)=>{$(L=>{const G=[...L];return G[s]={...G[s],[l]:o},G})},n=()=>{$(s=>[...s,{key:"",value:""}])},y=s=>{$(l=>l.filter((o,L)=>L!==s))},k=()=>{const s={title:u,body:C,templateId:i?Number(i):void 0,throttlePerMinute:p,mergeFields:O.reduce((l,o)=>(o.key&&(l[o.key]=o.value),l),{}),filters:{roles:M,propertyIds:B(b)},recipientIds:B(f)};return I?(s.sendStrategy="SCHEDULED",s.scheduledAt=new Date(I).toISOString()):s.sendStrategy="IMMEDIATE",s},Y=async()=>{j(null),R(null),h("preview");try{const s=k(),l=await N("/messaging/bulk/preview",{token:c,method:"POST",body:s});d(l),R(`Matched ${l.totalRecipients} recipients`)}catch(s){j(s.message),d(null)}finally{h(null)}},z=async()=>{j(null),R(null),h("send");try{const s=k();await N("/messaging/bulk",{token:c,method:"POST",body:s}),R("Bulk message queued successfully"),d(null),x&&x()}catch(s){j(s.message)}finally{h(null)}};return e.jsxs("section",{className:"space-y-4 rounded-lg border border-gray-200 bg-white p-4 shadow-sm",children:[e.jsxs("header",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Compose bulk message"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Select a template, target recipients, and personalize merge fields before sending."})]}),D&&e.jsx("div",{className:"rounded-md border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700",children:D}),T&&e.jsx("div",{className:"rounded-md border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-800",children:T}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Template"}),e.jsxs("select",{className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:i,onChange:s=>q(s.target.value),children:[e.jsx("option",{value:"",children:"Custom message"}),m.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),_?.description&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:_.description})]}),e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Subject"}),e.jsx("input",{className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:u,onChange:s=>v(s.target.value),placeholder:"Rent reminder, maintenance update, etc."})]})]}),e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Message body"}),e.jsx("textarea",{className:"min-h-32 w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:C,onChange:s=>g(s.target.value),placeholder:"Hi {{username}}, your rent is due on the 1st..."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Recipient roles"}),e.jsx("div",{className:"space-y-2 rounded-md border border-gray-200 p-3",children:Q.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:M.includes(s.value),onChange:l=>{l.target.checked?w(o=>Array.from(new Set([...o,s.value]))):w(o=>o.filter(L=>L!==s.value))}}),s.label]},s.value))})]}),e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Property IDs"}),e.jsx("input",{className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:b,onChange:s=>P(s.target.value),placeholder:"e.g. 10, 42"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Optional: limit tenants to certain properties."})]}),e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Direct recipient IDs"}),e.jsx("input",{className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:f,onChange:s=>r(s.target.value),placeholder:"e.g. 4, 9, 11"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Overrides filters to force-include specific users."})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("label",{className:"text-sm",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Throttle (messages/min)"}),e.jsx("input",{type:"number",min:1,className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:p,onChange:s=>F(Number(s.target.value)||1)})]}),e.jsxs("label",{className:"text-sm md:col-span-2",children:[e.jsx("span",{className:"mb-1 block font-medium text-gray-700",children:"Schedule send (optional)"}),e.jsx("input",{type:"datetime-local",className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm",value:I,onChange:s=>U(s.target.value)}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Leave empty to send immediately."})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Merge fields"}),e.jsx("button",{type:"button",className:"text-sm font-medium text-indigo-600 hover:underline",onClick:n,children:"Add field"})]}),e.jsx("div",{className:"space-y-2",children:O.map((s,l)=>e.jsxs("div",{className:"grid gap-2 md:grid-cols-[1fr_1fr_auto]",children:[e.jsx("input",{className:"rounded-md border border-gray-300 px-3 py-2 text-sm",placeholder:"Field key (e.g. managerName)",value:s.key,onChange:o=>t(l,"key",o.target.value)}),e.jsx("input",{className:"rounded-md border border-gray-300 px-3 py-2 text-sm",placeholder:"Value",value:s.value,onChange:o=>t(l,"value",o.target.value)}),e.jsx("button",{type:"button",className:"rounded-md border border-gray-200 px-3 py-2 text-sm text-gray-600 hover:bg-gray-50",onClick:()=>y(l),children:"Remove"})]},`${s.key}-${l}`))})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{type:"button",onClick:Y,disabled:S==="preview",className:"rounded-md bg-white px-4 py-2 text-sm font-medium text-gray-700 ring-1 ring-gray-200 hover:bg-gray-50 disabled:opacity-50",children:S==="preview"?"Generating preview…":"Preview recipients"}),e.jsx("button",{type:"button",onClick:z,disabled:S==="send",className:"rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500 disabled:opacity-50",children:S==="send"?"Queuing…":"Queue bulk send"})]}),E&&e.jsxs("div",{className:"rounded-lg border border-gray-100 bg-gray-50 p-4 text-sm",children:[e.jsxs("p",{className:"font-medium text-gray-900",children:["Preview will reach ",E.totalRecipients," recipients"]}),e.jsx("ul",{className:"mt-3 space-y-2",children:E.sample.map((s,l)=>e.jsxs("li",{className:"rounded-md border border-gray-200 bg-white p-3",children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.user.username}),e.jsx("p",{className:"text-gray-600",children:s.renderedContent})]},`${s.user.username}-${l}`))})]})]})},J=({token:c,batches:m,onRefresh:x})=>{const[u,v]=a.useState(null),[C,g]=a.useState([]),[i,A]=a.useState(null),[M,w]=a.useState(null),[b,P]=a.useState(!1);a.useEffect(()=>{if(u===null){g([]),A(null);return}(async()=>{P(!0),w(null);try{const[p,F]=await Promise.all([N(`/messaging/bulk/${u}/recipients`,{token:c}),N(`/messaging/bulk/${u}/report`,{token:c})]);g(p),A(F)}catch(p){w(p.message),g([]),A(null)}finally{P(!1)}})()},[u,c]);const f=m.find(r=>r.id===u)??null;return e.jsxs("section",{className:"space-y-4 rounded-lg border border-gray-200 bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Bulk delivery status"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Monitor queued campaigns and review delivery results."})]}),e.jsx("button",{type:"button",className:"rounded-md border border-gray-200 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",onClick:()=>{v(null),x()},children:"Refresh"})]}),M&&e.jsx("div",{className:"rounded-md border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700",children:M}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-3",children:[m.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No bulk messages have been queued yet."}),m.map(r=>e.jsxs("button",{type:"button",onClick:()=>v(r.id),className:`w-full rounded-lg border px-4 py-3 text-left text-sm transition ${u===r.id?"border-indigo-400 bg-indigo-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:r.title}),e.jsx("span",{className:"text-xs uppercase tracking-wide text-gray-500",children:r.status})]}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(r.createdAt).toLocaleString()}),r.deliverySummary&&e.jsxs("p",{className:"mt-1 text-xs text-gray-600",children:["Sent ",r.deliverySummary.sent,"/",r.deliverySummary.total," • Pending ",r.deliverySummary.pending," • Failed ",r.deliverySummary.failed]})]},r.id))]}),e.jsx("div",{className:"rounded-lg border border-dashed border-gray-200 p-4 text-sm",children:f?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-base font-semibold text-gray-900",children:f.title}),e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:f.status})]}),i&&e.jsxs("div",{className:"flex gap-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Total"}),e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:i.summary.total})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Sent"}),e.jsx("p",{className:"text-lg font-semibold text-emerald-600",children:i.summary.sent})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Pending"}),e.jsx("p",{className:"text-lg font-semibold text-amber-600",children:i.summary.pending})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Failed"}),e.jsx("p",{className:"text-lg font-semibold text-rose-600",children:i.summary.failed})]})]}),b?e.jsx("p",{className:"text-gray-500",children:"Loading delivery details…"}):C.length===0?e.jsx("p",{className:"text-gray-500",children:"No delivery attempts recorded yet."}):e.jsx("ul",{className:"max-h-64 space-y-2 overflow-y-auto",children:C.map(r=>e.jsxs("li",{className:"rounded-md border border-gray-200 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-gray-900",children:r.user.username}),e.jsx("span",{className:"text-xs uppercase tracking-wide text-gray-500",children:r.status})]}),r.errorMessage&&e.jsx("p",{className:"text-xs text-rose-600",children:r.errorMessage}),r.renderedContent&&e.jsx("p",{className:"mt-1 text-xs text-gray-600",children:r.renderedContent})]},r.id))}),i?.failures?.length?e.jsxs("div",{className:"rounded-md border border-rose-100 bg-rose-50 p-3 text-xs text-rose-700",children:[e.jsx("p",{className:"font-semibold",children:"Recent failures"}),e.jsx("ul",{className:"mt-1 list-disc pl-5",children:i.failures.map((r,p)=>e.jsxs("li",{children:["User #",r.userId,": ",r.errorMessage??"Unknown error"]},`${r.userId}-${p}`))})]}):null]}):e.jsx("p",{className:"text-gray-500",children:"Select a batch to view detailed delivery metrics."})})]})]})},K=c=>{if(!c)return"";const m=new Date(c);return Number.isNaN(m.getTime())?c:m.toLocaleString()},ne=()=>{const[c,m]=a.useState([]),[x,u]=a.useState(null),[v,C]=a.useState([]),[g,i]=a.useState(""),[A,M]=a.useState(!0),[w,b]=a.useState(null),[P,f]=a.useState(!1),[r,p]=a.useState(null),[F,I]=a.useState([]),[U,O]=a.useState([]),[$,E]=a.useState(!1),{token:d,user:S}=H(),h=S?.role==="PROPERTY_MANAGER",D=S?.username??S?.name??"",j=a.useCallback(async t=>{try{const n=await N(`/messaging/conversations/${t}`,{token:d});C(n.messages||n||[])}catch(n){b(n.message||"Failed to fetch messages")}},[d]);a.useEffect(()=>{d&&(async()=>{try{const n=await N("/messaging/conversations",{token:d});if(m(Array.isArray(n)?n:[]),Array.isArray(n)&&n.length>0){let y=!1;u(k=>k||(y=!0,n[0])),y&&j(n[0].id)}}catch(n){b(n.message||"Failed to fetch conversations")}finally{M(!1)}})()},[d,j]);const T=a.useCallback(async()=>{if(!(!d||!h)){E(!0),p(null);try{const[t,n]=await Promise.all([N("/messaging/bulk",{token:d}),N("/messaging/templates",{token:d})]);if(!t.ok)throw new Error("Failed to load bulk message batches");if(!n.ok)throw new Error("Failed to load templates");const[y,k]=await Promise.all([t.json(),n.json()]);I(Array.isArray(y)?y:[]),O(Array.isArray(k)?k:[])}catch(t){p(t.message)}finally{E(!1)}}},[h,d]);a.useEffect(()=>{d&&h&&T()},[d,h,T]);const R=t=>{u(t),j(t.id)},_=async()=>{if(!(!x||!g.trim()||!d)){f(!0),b(null);try{await N("/messaging/messages",{token:d,method:"POST",body:{conversationId:x.id,content:g.trim()}}),i(""),j(x.id)}catch(t){b(t.message)}finally{f(!1)}}};if(!d)return e.jsx("div",{className:"p-4 text-sm text-gray-600",children:"Sign in to access your inbox."});if(A)return e.jsx("div",{className:"p-4 text-sm text-gray-600",children:"Loading conversations…"});const B=t=>t?t.title??t.subject??(Array.isArray(t.participants)?t.participants.map(n=>n.username??n.name).filter(Boolean).join(", "):void 0)??(t.property?.name?`Property ${t.property.name}`:void 0)??`Conversation #${t.id}`:"Conversation",q=t=>t?t.lastMessage?.content?t.lastMessage.content:t.preview?t.preview:Array.isArray(t.messages)&&t.messages.length>0?t.messages[t.messages.length-1].content??"":"":"";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Messaging inbox"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Stay on top of maintenance updates, rent reminders, and chat with staff in real time."})]}),w&&e.jsx("div",{className:"rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700",children:w}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,2fr)]",children:[e.jsxs("aside",{className:"rounded-lg border border-gray-200 bg-white shadow-sm",children:[e.jsxs("div",{className:"border-b border-gray-200 px-4 py-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-900",children:"Conversations"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Select a thread to view the conversation."})]}),e.jsx("ul",{className:"max-h-112 divide-y divide-gray-100 overflow-y-auto text-sm",children:c.length===0?e.jsx("li",{className:"px-4 py-6 text-center text-gray-500",children:"No conversations yet."}):c.map(t=>{const n=x?.id===t.id;return e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>R(t),className:`flex w-full flex-col items-start px-4 py-3 text-left transition ${n?"bg-indigo-50":"hover:bg-gray-50"}`,children:[e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:B(t)}),e.jsx("span",{className:"mt-1 line-clamp-2 text-xs text-gray-500",children:q(t)||"No messages yet."})]})},t.id)})})]}),e.jsx("section",{className:"flex min-h-112 flex-col rounded-lg border border-gray-200 bg-white shadow-sm",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-b border-gray-200 px-4 py-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:B(x)}),x.property?.name&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Property: ",x.property.name]})]}),e.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto px-4 py-4",children:v.length===0?e.jsx("div",{className:"rounded border border-dashed border-gray-300 py-12 text-center text-sm text-gray-500",children:"No messages yet. Start the conversation below."}):v.map(t=>{const n=t.author?.username??t.author?.name??(t.fromTenant?"Tenant":t.fromStaff?"Staff":"System"),y=D&&n===D;return e.jsxs("div",{className:`flex flex-col ${y?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`max-w-md rounded-lg px-4 py-2 text-sm shadow-sm ${y?"bg-indigo-600 text-white":"bg-gray-100 text-gray-800"}`,children:[e.jsx("p",{className:"font-semibold",children:y?"You":n}),e.jsx("p",{className:"mt-1 whitespace-pre-wrap text-sm",children:t.content})]}),e.jsx("span",{className:"mt-1 text-xs text-gray-500",children:K(t.createdAt??t.sentAt??t.updatedAt)})]},t.id??`${t.createdAt}-${t.content}`)})}),e.jsx("div",{className:"border-t border-gray-200 bg-gray-50 px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsx("textarea",{rows:2,value:g,onChange:t=>i(t.target.value),placeholder:"Write a message…",className:"flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"}),e.jsx("button",{type:"button",onClick:_,disabled:P||!g.trim(),className:"inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 disabled:cursor-not-allowed disabled:bg-indigo-300",children:P?"Sending…":"Send"})]})})]}):e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 text-center text-sm text-gray-500",children:"Select a conversation to view messages."})})]}),h&&d&&e.jsxs("section",{className:"space-y-4 rounded-lg border border-gray-200 bg-white p-4 shadow-sm",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Bulk messaging"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Send targeted announcements with merge-field personalization and track delivery results in real time."})]}),r&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800",children:r}),$?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading bulk messaging tools…"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(W,{token:d,templates:U,onBatchCreated:T}),e.jsx(J,{token:d,batches:F,onRefresh:T})]})]})]})};export{ne as default};
