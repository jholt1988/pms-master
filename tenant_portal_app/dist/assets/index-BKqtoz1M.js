import{r,j as e}from"./react-vendor-Cz9WDxg-.js";import{u as X}from"./index-BHiZdJVs.js";import{a as o}from"./apiClient-DATCuIGb.js";import{S,D as k}from"./DataTable-D59aytRp.js";import{P as Z}from"./PageHeader-mjJTmpC5.js";import{u as ee,c as i,a as d,d as L,v as te,k as ae,i as g,s as O,l as j,b,m as se,f as ne,g as re,h as le,j as oe}from"./nextui-vendor-BpFfdwSS.js";import"./vendor-BVwjo9X5.js";import"./utils-vendor-9uJw-9S8.js";import"./lucide-icons-D0L7Z31B.js";import"./framer-motion-hFs7l1RU.js";import"./useViewportCategory-ClZR3Wdj.js";const $={type:"CARD",provider:"STRIPE",last4:"",brand:"",expMonth:"",expYear:"",providerCustomerId:"",providerPaymentMethodId:""},ie=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),m=a=>a==null?"—":ie.format(a),v=a=>{if(!a)return"—";const u=new Date(a);return Number.isNaN(u.getTime())?"—":u.toLocaleDateString()};function ve(){const{token:a}=X(),{isOpen:u,onOpen:R,onOpenChange:M}=ee(),[A,z]=r.useState([]),[E,B]=r.useState([]),[N,P]=r.useState([]),[l,c]=r.useState($),[w,p]=r.useState(null),[V,D]=r.useState(""),[C,_]=r.useState(""),[K,I]=r.useState(!0),[T,F]=r.useState(!1),[U,h]=r.useState(null),[Y,G]=r.useState(null),x=A.filter(t=>["PENDING","DUE","OVERDUE"].includes(t.status.toUpperCase())),H=x.reduce((t,n)=>t+n.amount,0),y=x.sort((t,n)=>new Date(t.dueDate).getTime()-new Date(n.dueDate).getTime())[0],f=E.filter(t=>["COMPLETED","SETTLED"].includes(t.status.toUpperCase())).sort((t,n)=>new Date(n.paymentDate).getTime()-new Date(t.paymentDate).getTime())[0],q=[{key:"invoiceId",label:"INVOICE"},{key:"dueDate",label:"DUE DATE"},{key:"amount",label:"AMOUNT"},{key:"status",label:"STATUS"}],J=[{key:"paymentId",label:"PAYMENT"},{key:"paymentDate",label:"DATE"},{key:"amount",label:"AMOUNT"},{key:"status",label:"STATUS"}];r.useEffect(()=>{const t=async()=>{if(!a)return;const[s,W]=await Promise.all([o("/payments/invoices",{token:a}),o("/payments",{token:a})]);z(s),B(W)},n=async()=>{if(a){try{const s=await o("/payment-methods",{token:a});P(s)}catch(s){console.error("Failed to fetch payment methods:",s)}try{const s=await o("/billing/autopay",{token:a});p(s),s.enrollment?.paymentMethodId&&_(String(s.enrollment.paymentMethodId)),typeof s.enrollment?.maxAmount=="number"&&D(String(s.enrollment.maxAmount))}catch(s){s.message?.includes("404")?p(null):console.error("Failed to fetch autopay status:",s)}}};(async()=>{if(!a){I(!1);return}try{h(null),await Promise.all([t(),n()])}catch(s){console.error("Error loading payment data:",s),h(s instanceof Error?s.message:"Failed to load payment information")}finally{I(!1)}})()},[a]);const Q=async()=>{if(!(!a||T))try{F(!0),h(null),await o("/payment-methods",{token:a,method:"POST",body:l});try{const t=await o("/payment-methods",{token:a});P(t)}catch(t){console.error("Failed to fetch payment methods:",t)}try{const t=await o("/billing/autopay",{token:a});p(t),t.enrollment?.paymentMethodId&&_(String(t.enrollment.paymentMethodId)),typeof t.enrollment?.maxAmount=="number"&&D(String(t.enrollment.maxAmount))}catch(t){t.message?.includes("404")?p(null):console.error("Failed to fetch autopay status:",t)}c($),G("Payment method added successfully!"),M()}catch(t){console.error("Error adding payment method:",t),h(t instanceof Error?t.message:"Failed to add payment method")}finally{F(!1)}};return K?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(i,{className:"w-96",children:e.jsxs(d,{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-medium text-foreground-600",children:"Loading payment information..."})]})})}):e.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-8",children:[e.jsx(Z,{title:"Payments & billing",subtitle:"Review open invoices, payment history, and manage autopay preferences for your lease."}),U&&e.jsx(i,{className:"border-danger-200 bg-danger-50",children:e.jsx(d,{children:e.jsx("p",{className:"text-small text-danger-700",children:U})})}),Y&&e.jsx(i,{className:"border-success-200 bg-success-50",children:e.jsx(d,{children:e.jsx("p",{className:"text-small text-success-700",children:Y})})}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-3",children:[e.jsx(S,{title:"Balance due",value:m(H),subtitle:`${x.length} open invoice${x.length===1?"":"s"}`}),e.jsx(S,{title:"Next due date",value:y?v(y.dueDate):"—",subtitle:y?`Amount ${m(y.amount)}`:"No upcoming invoices",valueColor:"warning"}),e.jsx(S,{title:"Last payment",value:f?m(f.amount):"—",subtitle:f?`Paid ${v(f.paymentDate)}`:"No payment history yet",valueColor:"success"})]}),e.jsxs("div",{className:"grid gap-8 lg:grid-cols-[2fr_1fr]",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(k,{title:"Invoices",subtitle:"Statements generated for your lease.",columns:q,data:A.map(t=>({...t,invoiceId:`#${t.id}`,dueDate:v(t.dueDate),amount:m(t.amount)})),emptyContent:"No invoices have been generated yet."}),e.jsx(k,{title:"Payment history",subtitle:"Your recent payment transactions.",columns:J,data:E.map(t=>({...t,paymentId:`#${t.id}`,paymentDate:v(t.paymentDate),amount:m(t.amount)})),emptyContent:"No payment history yet."})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(i,{className:"shadow-medium",children:[e.jsx(L,{className:"pb-4",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Autopay settings"}),e.jsx("p",{className:"text-small text-foreground-500",children:"Automatically pay your rent."})]})}),e.jsxs(d,{className:"pt-0 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-small font-medium",children:"Enable autopay"}),e.jsx(te,{isSelected:w?.enrollment?.active||!1,size:"sm"})]}),w?.enrollment?.active&&e.jsxs(e.Fragment,{children:[e.jsx(ae,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(g,{label:"Maximum amount",placeholder:"Enter max amount",value:V,onChange:t=>D(t.target.value),startContent:"$",size:"sm"}),e.jsx(O,{label:"Payment method",placeholder:"Select payment method",selectedKeys:C?[C]:[],size:"sm",children:N.map(t=>e.jsxs(j,{value:t.id.toString(),children:[t.brand," •••• ",t.last4]},t.id))})]})]})]})]}),e.jsxs(i,{className:"shadow-medium",children:[e.jsxs(L,{className:"pb-4 flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Payment methods"}),e.jsx("p",{className:"text-small text-foreground-500",children:"Manage your saved cards."})]}),e.jsx(b,{color:"primary",size:"sm",onPress:R,children:"Add method"})]}),e.jsx(d,{className:"pt-0",children:N.length===0?e.jsx("p",{className:"text-small text-foreground-400 text-center py-4",children:"No payment methods saved yet."}):e.jsx("div",{className:"space-y-3",children:N.map(t=>e.jsx(i,{className:"border border-divider",children:e.jsx(d,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-small font-medium",children:[t.brand," •••• ",t.last4]}),e.jsxs("p",{className:"text-tiny text-foreground-400",children:["Expires ",t.expMonth,"/",t.expYear]})]}),e.jsx(b,{color:"danger",variant:"light",size:"sm",className:"text-tiny",children:"Remove"})]})})},t.id))})})]})]})]}),e.jsx(se,{isOpen:u,onOpenChange:M,children:e.jsx(ne,{children:t=>e.jsxs(e.Fragment,{children:[e.jsx(re,{children:"Add Payment Method"}),e.jsx(le,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{label:"Card Number",placeholder:"1234 5678 9012 3456",value:l.last4,onChange:n=>c({...l,last4:n.target.value.slice(-4)})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(g,{label:"Expiry Month",placeholder:"MM",value:l.expMonth,onChange:n=>c({...l,expMonth:n.target.value})}),e.jsx(g,{label:"Expiry Year",placeholder:"YYYY",value:l.expYear,onChange:n=>c({...l,expYear:n.target.value})})]}),e.jsxs(O,{label:"Card Brand",selectedKeys:l.brand?[l.brand]:[],onChange:n=>c({...l,brand:n.target.value}),children:[e.jsx(j,{value:"visa",children:"Visa"},"visa"),e.jsx(j,{value:"mastercard",children:"Mastercard"},"mastercard"),e.jsx(j,{value:"amex",children:"American Express"},"amex")]})]})}),e.jsxs(oe,{children:[e.jsx(b,{variant:"light",onPress:t,children:"Cancel"}),e.jsx(b,{color:"primary",onPress:Q,isLoading:T,children:"Add Method"})]})]})})})]})}export{ve as PaymentsPage};
