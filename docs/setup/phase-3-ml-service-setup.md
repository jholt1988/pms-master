# Phase 3: Python ML Microservice Integration Guide

## ğŸ¯ Overview

This document provides complete instructions for setting up and running the Python ML microservice for AI-powered rent optimization.

## ğŸ“‹ Prerequisites

- Python 3.9 or higher
- Node.js 18+ (for NestJS backend)
- PostgreSQL database running
- Both frontend and backend servers

## ğŸš€ Quick Start

### Step 1: Install Python ML Service

```cmd
cd rent_optimization_ml

REM Create virtual environment
python -m venv venv

REM Activate virtual environment
venv\Scripts\activate

REM Install dependencies
pip install -r requirements.txt

REM Configure environment
copy .env.example .env
```

Edit `.env` file (optional - works with mock data by default):
```env
API_PORT=8000
ML_SERVICE_URL=http://localhost:8000
USE_MARKET_DATA=true
```

### Step 2: Start ML Service

```cmd
REM Make sure you're in rent_optimization_ml directory
REM and virtual environment is activated
python main.py
```

Or use uvicorn directly:
```cmd
uvicorn main:app --reload --port 8000
```

Service will start at **http://localhost:8000**

### Step 3: Verify ML Service

Open browser to http://localhost:8000/docs to see Swagger API documentation.

Test health endpoint:
```cmd
curl http://localhost:8000/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "rent-optimization-ml",
  "version": "1.0.0",
  "environment": "development",
  "model_status": "loaded",
  "model_version": "1.0.0-mock"
}
```

### Step 4: Enable ML Service in NestJS Backend

Edit `tenant_portal_backend\.env`:
```env
ML_SERVICE_URL="http://localhost:8000"
USE_ML_SERVICE="true"  # Change from "false" to "true"
```

Restart the NestJS backend:
```cmd
cd tenant_portal_backend
npm run start:dev
```

### Step 5: Test End-to-End

1. **Login** to frontend at http://localhost:3000 as `admin_pm` / `password123`
2. **Navigate** to "AI Rent Optimization"
3. **Click "Generate New"** - This will now call the Python ML service!
4. **View recommendations** - Generated by ML service
5. **Check logs** - NestJS backend will show "ML service prediction for unit X: $Y"

## ğŸ”§ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Frontend (React)                                   â”‚
â”‚           http://localhost:3000                              â”‚
â”‚           Click "Generate New"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ POST /api/rent-recommendations/generate
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           NestJS Backend                                     â”‚
â”‚           http://localhost:3001                              â”‚
â”‚                                                              â”‚
â”‚  RentOptimizationService.generateRecommendations()          â”‚
â”‚  â”œâ”€ Fetch unit data from PostgreSQL                         â”‚
â”‚  â””â”€ Call ML service via HTTP                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ POST http://localhost:8000/predict
                       â”‚ {unit_id, bedrooms, current_rent, ...}
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Python ML Microservice                             â”‚
â”‚           http://localhost:8000                              â”‚
â”‚                                                              â”‚
â”‚  FastAPI main.py                                             â”‚
â”‚  â”œâ”€ PredictionService.predict()                             â”‚
â”‚  â”‚   â”œâ”€ Extract features                                    â”‚
â”‚  â”‚   â”œâ”€ Get market comparables                              â”‚
â”‚  â”‚   â”œâ”€ Run ML model (or baseline)                          â”‚
â”‚  â”‚   â”œâ”€ Calculate factors                                   â”‚
â”‚  â”‚   â””â”€ Generate reasoning                                  â”‚
â”‚  â””â”€ Return prediction                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Prediction response
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           NestJS saves to PostgreSQL                         â”‚
â”‚           RentRecommendation table                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Recommendation with ML predictions
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Frontend displays cards                            â”‚
â”‚           with ML-generated recommendations                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª Testing

### Test ML Service Directly

```cmd
curl -X POST http://localhost:8000/predict \
  -H "Content-Type: application/json" \
  -d "{\"unit_id\": \"test-1\", \"property_type\": \"APARTMENT\", \"bedrooms\": 2, \"bathrooms\": 2.0, \"square_feet\": 1200, \"address\": \"123 Test St\", \"city\": \"Seattle\", \"state\": \"WA\", \"zip_code\": \"98101\", \"current_rent\": 2500, \"has_parking\": true, \"has_laundry\": true, \"has_pool\": false, \"has_gym\": true, \"has_hvac\": true, \"is_furnished\": false, \"pets_allowed\": true, \"year_built\": 2018}"
```

Or use PowerShell:
```powershell
$body = @{
    unit_id = "test-1"
    property_type = "APARTMENT"
    bedrooms = 2
    bathrooms = 2.0
    square_feet = 1200
    address = "123 Test St"
    city = "Seattle"
    state = "WA"
    zip_code = "98101"
    current_rent = 2500
    has_parking = $true
    has_laundry = $true
    has_pool = $false
    has_gym = $true
    has_hvac = $true
    is_furnished = $false
    pets_allowed = $true
    year_built = 2018
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8000/predict" -Method Post -Body $body -ContentType "application/json"
```

### Test via NestJS Backend

With `USE_ML_SERVICE="true"` in backend .env:

1. Login to frontend
2. Click "Generate New"
3. Check backend logs for: `ML service prediction for unit...`
4. Check ML service logs for: `Prediction request for unit...`

### Verify Database

```sql
SELECT 
  id,
  "unitId",
  "currentRent",
  "recommendedRent",
  "modelVersion",
  "reasoning",
  status
FROM "RentRecommendation"
ORDER BY "generatedAt" DESC
LIMIT 5;
```

Should see `modelVersion = "1.0.0"` (from ML service) instead of `"mock-v1.0"` (from NestJS mock)

## ğŸ“Š API Endpoints

### ML Service Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/` | Root health check |
| GET | `/health` | Detailed health status |
| GET | `/model/info` | Model metadata |
| POST | `/predict` | Single rent prediction |
| POST | `/predict/batch` | Batch predictions |
| GET | `/docs` | Swagger API docs |

### Request Schema

```typescript
{
  unit_id: string;
  property_type: 'APARTMENT' | 'HOUSE' | 'CONDO' | 'TOWNHOUSE' | 'STUDIO';
  bedrooms: number;
  bathrooms: number;
  square_feet: number;
  address: string;
  city: string;
  state: string;
  zip_code: string;
  current_rent: number;
  has_parking: boolean;
  has_laundry: boolean;
  has_pool: boolean;
  has_gym: boolean;
  has_hvac: boolean;
  is_furnished: boolean;
  pets_allowed: boolean;
  year_built?: number;
  floor_number?: number;
}
```

### Response Schema

```typescript
{
  unit_id: string;
  current_rent: number;
  recommended_rent: number;
  confidence_interval_low: number;
  confidence_interval_high: number;
  confidence_score: number;  // 0-1
  factors: Array<{
    name: string;
    impact_percentage: number;
    description: string;
  }>;
  market_comparables: Array<{
    address: string;
    rent: number;
    bedrooms: number;
    bathrooms: number;
    square_feet: number;
    distance_miles: number;
    similarity_score: number;  // 0-1
  }>;
  reasoning: string;
  model_version: string;
  market_trend: 'rising' | 'stable' | 'declining';
  seasonality_factor?: number;
  generated_at: string;  // ISO datetime
}
```

## ğŸ› Troubleshooting

### ML Service Won't Start

**Error**: `ModuleNotFoundError: No module named 'fastapi'`

**Solution**:
```cmd
cd rent_optimization_ml
venv\Scripts\activate
pip install -r requirements.txt
```

### Backend Can't Connect to ML Service

**Error**: `Error calling ML service: connect ECONNREFUSED 127.0.0.1:8000`

**Solutions**:
1. Verify ML service is running: `curl http://localhost:8000/health`
2. Check `ML_SERVICE_URL` in backend `.env`
3. Check firewall settings
4. Set `USE_ML_SERVICE="false"` to use mock data temporarily

### Port Already in Use

**Error**: `OSError: [WinError 10048] Only one usage of each socket address`

**Solution**:
```cmd
netstat -ano | findstr :8000
taskkill /PID <process_id> /F
```

Or change port in ML service:
```cmd
uvicorn main:app --port 8001
```

And update backend `.env`:
```env
ML_SERVICE_URL="http://localhost:8001"
```

### Import Errors in Python

**Error**: `Import "pydantic_settings" could not be resolved`

These are expected in VSCode until Python packages are installed. Ignore if service runs fine.

## ğŸ”„ Development Workflow

### Modify ML Algorithm

1. Edit `rent_optimization_ml/app/services/prediction_service.py`
2. Update `_baseline_prediction()` method
3. Save file
4. Service auto-reloads (if running with `--reload`)
5. Test new prediction logic

### Add New Features

1. Update `app/models/schemas.py` - add field to `PredictionRequest`
2. Update `app/services/prediction_service.py` - extract new feature
3. Update backend `rent-optimization.service.ts` - include in request
4. Restart both services
5. Test end-to-end

### Switch Between Mock and ML

**Use NestJS Mock** (faster, no Python needed):
```env
USE_ML_SERVICE="false"
```

**Use Python ML Service** (more features, realistic):
```env
USE_ML_SERVICE="true"
```

## ğŸ“¦ Docker Deployment

### Build Docker Image

```cmd
cd rent_optimization_ml
docker build -t rent-optimization-ml:latest .
```

### Run Container

```cmd
docker run -d \
  -p 8000:8000 \
  --name ml-service \
  --env-file .env \
  rent-optimization-ml:latest
```

### Docker Compose

```cmd
docker-compose up -d
```

Stops all containers:
```cmd
docker-compose down
```

## ğŸ¯ Next Steps

### Phase 3.2: Real ML Model

- [ ] Collect historical rent data
- [ ] Train XGBoost model
- [ ] Integrate Zillow/Rentometer APIs
- [ ] Replace baseline with trained model
- [ ] Add confidence thresholding

### Phase 3.3: Advanced Features

- [ ] Model retraining pipeline
- [ ] A/B testing framework
- [ ] Economic indicators
- [ ] Multi-model ensemble
- [ ] ML monitoring dashboard

## ğŸ“š Additional Resources

- FastAPI Documentation: https://fastapi.tiangolo.com
- XGBoost Guide: https://xgboost.readthedocs.io
- Zillow API: https://www.zillow.com/howto/api/
- Rentometer API: https://www.rentometer.com/api

## âœ… Verification Checklist

Before proceeding:

- [ ] Python 3.9+ installed
- [ ] Virtual environment created and activated
- [ ] All pip packages installed
- [ ] ML service starts at http://localhost:8000
- [ ] `/health` endpoint returns 200
- [ ] Swagger docs accessible at `/docs`
- [ ] Backend `.env` configured
- [ ] NestJS backend restarted
- [ ] End-to-end test successful
- [ ] Database shows ML-generated recommendations

## ğŸ‰ Success Criteria

You know it's working when:

1. âœ… ML service logs show: `âœ… ML Service ready to serve predictions`
2. âœ… Generate New creates recommendations
3. âœ… Backend logs show: `ML service prediction for unit X: $Y`
4. âœ… Database `modelVersion` = `"1.0.0"` (not `"mock-v1.0"`)
5. âœ… Recommendations display in frontend
6. âœ… Factors and comparables show realistic data

---

**Need Help?** Check backend and ML service logs for detailed error messages.
